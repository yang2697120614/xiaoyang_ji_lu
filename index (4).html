<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>药物用量追踪器</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#60a5fa',
                        accent: '#93c5fd',
                        neutral: '#f3f4f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .calendar-day {
                transition: all 0.3s ease;
            }
            .calendar-day:hover:not(.empty) {
                transform: translateY(-3px);
            }
            .dose-highlight {
                position: relative;
                overflow: hidden;
            }
            .dose-highlight::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
                z-index: -1;
            }
            .dose-1::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.1) 100%);
                z-index: -1;
            }
            .dose-2::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.1) 100%);
                z-index: -1;
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-6xl">
        <!-- 头部 -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-primary mb-2">药物用量追踪器</h1>
            <p class="text-gray-600">轻松管理您的每日用药计划</p>
        </header>

        <!-- 主内容区 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 设置面板 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-card p-6 mb-6 transform transition-all duration-300 hover:shadow-card-hover">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-sliders mr-2 text-primary"></i>用药设置
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="dose1" class="block text-sm font-medium text-gray-700 mb-1">剂量 1</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-medkit"></i>
                                </span>
                                <input type="number" id="dose1" step="0.25" min="0.25" 
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="例如：1.5">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">片</span>
                            </div>
                        </div>
                        
                        <div>
                            <label for="dose2" class="block text-sm font-medium text-gray-700 mb-1">剂量 2</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-medkit"></i>
                                </span>
                                <input type="number" id="dose2" step="0.25" min="0.25" 
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="例如：1.75">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">片</span>
                            </div>
                        </div>
                        
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                    <i class="fa fa-calendar"></i>
                                </span>
                                <input type="date" id="startDate" 
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="pt-2">
                            <button id="saveSettings" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                                <i class="fa fa-save mr-2"></i>保存设置
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 今日用药状态 -->
                <div class="bg-white rounded-xl shadow-card p-6 transform transition-all duration-300 hover:shadow-card-hover">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-clock-o mr-2 text-primary"></i>今日用药
                    </h2>
                    
                    <div id="todayStatus" class="text-center py-4">
                        <div class="text-3xl font-bold mb-2" id="todayDose">--</div>
                        <div class="text-gray-600 mb-4">片</div>
                        
                        <div class="flex justify-center space-x-2 sm:space-x-4">
                            <button id="markTaken" class="bg-success hover:bg-green-600 text-white font-medium py-2 px-4 sm:px-6 rounded-lg transition-colors duration-300 flex items-center text-sm sm:text-base">
                                <i class="fa fa-check mr-1 sm:mr-2"></i>已服用
                            </button>
                            <button id="markMissed" class="bg-danger hover:bg-red-600 text-white font-medium py-2 px-4 sm:px-6 rounded-lg transition-colors duration-300 flex items-center text-sm sm:text-base">
                                <i class="fa fa-times mr-1 sm:mr-2"></i>未服用
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 日历和统计 -->
            <div class="lg:col-span-2">
                <!-- 日历控制 -->
                <div class="bg-white rounded-xl shadow-card p-6 mb-6 transform transition-all duration-300 hover:shadow-card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fa fa-calendar-check-o mr-2 text-primary"></i>用药日历
                        </h2>
                        
                        <div class="flex space-x-2">
                            <button id="prevMonth" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                                <i class="fa fa-chevron-left mr-1"></i>
                            </button>
                            <h3 id="currentMonth" class="text-lg font-medium text-gray-800 flex items-center justify-center px-4">2023年7月</h3>
                            <button id="nextMonth" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                                <i class="fa fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 日历网格 -->
                    <div class="grid grid-cols-7 gap-2">
                        <!-- 星期标题 -->
                        <div class="text-center font-medium text-gray-500 py-2">日</div>
                        <div class="text-center font-medium text-gray-500 py-2">一</div>
                        <div class="text-center font-medium text-gray-500 py-2">二</div>
                        <div class="text-center font-medium text-gray-500 py-2">三</div>
                        <div class="text-center font-medium text-gray-500 py-2">四</div>
                        <div class="text-center font-medium text-gray-500 py-2">五</div>
                        <div class="text-center font-medium text-gray-500 py-2">六</div>
                        
                        <!-- 日历天数将通过JavaScript动态生成 -->
                        <div id="calendarDays" class="col-span-7 grid grid-cols-7 gap-2">
                            <!-- 日历内容将在这里动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 统计信息 -->
                <div class="bg-white rounded-xl shadow-card p-6 transform transition-all duration-300 hover:shadow-card-hover">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-bar-chart mr-2 text-primary"></i>用药统计
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <!-- 本周用药统计 -->
                        <div>
                            <h3 class="text-base sm:text-lg font-medium text-gray-700 mb-2 sm:mb-3">本周用药情况</h3>
                            <div class="h-48 sm:h-64">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 本月用药统计 -->
                        <div>
                            <h3 class="text-base sm:text-lg font-medium text-gray-700 mb-2 sm:mb-3">本月用药总量</h3>
                            <div class="h-48 sm:h-64">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 用药依从性 -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">用药依从性</h3>
                        <div class="bg-gray-200 rounded-full h-4 mb-2">
                            <div id="adherenceBar" class="bg-primary h-4 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>已服用: <span id="takenCount">0</span> 天</span>
                            <span>总天数: <span id="totalDays">0</span> 天</span>
                            <span>依从率: <span id="adherenceRate">0</span>%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>© 2023 药物用量追踪器 | 数据仅存储在本地浏览器中</p>
        </footer>
    </div>

    <!-- 提示框 -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 translate-y-20 opacity-0 transition-all duration-300 flex items-center bg-green-500 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg shadow-lg">
        <i class="fa fa-check-circle mr-2"></i>
        <span id="toastMessage">操作成功</span>
    </div>

    <script>
        // 全局变量
        let settings = {
            dose1: 1.5,
            dose2: 1.75,
            startDate: new Date()
        };
        
        let medicationRecords = {};
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        
        // DOM元素
        const dose1Input = document.getElementById('dose1');
        const dose2Input = document.getElementById('dose2');
        const startDateInput = document.getElementById('startDate');
        const saveSettingsBtn = document.getElementById('saveSettings');
        const calendarDays = document.getElementById('calendarDays');
        const currentMonthEl = document.getElementById('currentMonth');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const todayDoseEl = document.getElementById('todayDose');
        const markTakenBtn = document.getElementById('markTaken');
        const markMissedBtn = document.getElementById('markMissed');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const adherenceBar = document.getElementById('adherenceBar');
        const takenCountEl = document.getElementById('takenCount');
        const totalDaysEl = document.getElementById('totalDays');
        const adherenceRateEl = document.getElementById('adherenceRate');
        
        // 图表对象
        let weeklyChart = null;
        let monthlyChart = null;
        
        // 初始化
        function init() {
            loadSettings();
            loadMedicationRecords();
            updateSettingsUI();
            renderCalendar(currentMonth, currentYear);
            updateTodayStatus();
            updateStatistics();
            setupEventListeners();
        }
        
        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('medicationSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                settings.startDate = new Date(settings.startDate);
            } else {
                // 默认设置
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                settings.startDate = today;
                saveSettings();
            }
        }
        
        // 保存设置
        function saveSettings() {
            localStorage.setItem('medicationSettings', JSON.stringify(settings));
        }
        
        // 加载用药记录
        function loadMedicationRecords() {
            const savedRecords = localStorage.getItem('medicationRecords');
            if (savedRecords) {
                medicationRecords = JSON.parse(savedRecords);
            }
        }
        
        // 保存用药记录
        function saveMedicationRecords() {
            localStorage.setItem('medicationRecords', JSON.stringify(medicationRecords));
        }
        
        // 更新设置UI
        function updateSettingsUI() {
            dose1Input.value = settings.dose1;
            dose2Input.value = settings.dose2;
            
            const startDateStr = settings.startDate.toISOString().split('T')[0];
            startDateInput.value = startDateStr;
        }
        
        // 渲染日历
        function renderCalendar(month, year) {
            calendarDays.innerHTML = '';
            
            // 更新当前月份显示
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            currentMonthEl.textContent = `${year}年${monthNames[month]}`;
            
            // 获取当月第一天是星期几
            const firstDay = new Date(year, month, 1).getDay();
            
            // 获取当月天数
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // 添加上个月的天数作为填充
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty h-24 bg-gray-50 rounded-lg';
                calendarDays.appendChild(emptyDay);
            }
            
            // 添加当月的天数
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === new Date().toDateString();
                
                // 计算当日剂量
                const dose = calculateDose(date);
                
                // 创建日历天数元素
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day h-24 p-2 rounded-lg border ${isToday ? 'ring-2 ring-primary ring-offset-2' : 'border-gray-200 hover:border-primary'} relative overflow-hidden`;
                
                // 如果是过去的日期且有记录，添加状态类
                if (date <= new Date() && medicationRecords[dateStr]) {
                    const status = medicationRecords[dateStr].status;
                    if (status === 'taken') {
                        dayEl.classList.add('bg-green-50');
                    } else if (status === 'missed') {
                        dayEl.classList.add('bg-red-50');
                    }
                }
                
                // 如果剂量是第一种或第二种，添加相应的类
                if (dose === settings.dose1) {
                    dayEl.classList.add('dose-1');
                } else if (dose === settings.dose2) {
                    dayEl.classList.add('dose-2');
                }
                
                // 添加日期数字
                const dateNumber = document.createElement('div');
                dateNumber.className = `text-lg font-medium ${isToday ? 'text-primary' : 'text-gray-800'}`;
                dateNumber.textContent = day;
                dayEl.appendChild(dateNumber);
                
                // 添加剂量信息
                const doseEl = document.createElement('div');
                doseEl.className = 'mt-1 text-sm';
                
                // 如果是未来日期，显示预测剂量
                if (date > new Date()) {
                    doseEl.innerHTML = `<span class="text-gray-500">预计: </span><span class="font-medium text-gray-800">${dose}</span><span class="text-gray-500">片</span>`;
                } else {
                    // 如果是过去或今天的日期，显示实际剂量
                    doseEl.innerHTML = `<span class="font-medium text-gray-800">${dose}</span><span class="text-gray-500">片</span>`;
                    
                    // 如果有用药记录，显示状态
                    if (medicationRecords[dateStr]) {
                        const status = medicationRecords[dateStr].status;
                        const statusEl = document.createElement('div');
                        statusEl.className = `mt-1 text-xs ${status === 'taken' ? 'text-green-600' : 'text-red-600'}`;
                        statusEl.innerHTML = status === 'taken' ? 
                            '<i class="fa fa-check-circle"></i> 已服用' : 
                            '<i class="fa fa-times-circle"></i> 未服用';
                        dayEl.appendChild(statusEl);
                    } else if (date < new Date()) {
                        // 如果是过去的日期但没有记录，显示未记录状态
                        const statusEl = document.createElement('div');
                        statusEl.className = 'mt-1 text-xs text-gray-500';
                        statusEl.innerHTML = '<i class="fa fa-question-circle"></i> 未记录';
                        dayEl.appendChild(statusEl);
                    }
                }
                
                dayEl.appendChild(doseEl);
                
                // 如果是今天或过去的日期，添加点击事件以标记用药状态
                if (date <= new Date()) {
                    dayEl.style.cursor = 'pointer';
                    dayEl.addEventListener('click', () => showStatusDialog(date));
                }
                
                calendarDays.appendChild(dayEl);
            }
            
            // 计算需要添加的下个月天数
            const totalDaysAdded = firstDay + daysInMonth;
            const remainingCells = 7 - (totalDaysAdded % 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty h-24 bg-gray-50 rounded-lg';
                    calendarDays.appendChild(emptyDay);
                }
            }
        }
        
        // 计算指定日期的剂量
        function calculateDose(date) {
            // 确保日期对象是纯净的（时间部分为0）
            const cleanDate = new Date(date);
            cleanDate.setHours(0, 0, 0, 0);
            
            const cleanStartDate = new Date(settings.startDate);
            cleanStartDate.setHours(0, 0, 0, 0);
            
            // 如果日期在开始日期之前，返回0
            if (cleanDate < cleanStartDate) {
                return 0;
            }
            
            // 计算距离开始日期的天数差
            const timeDiff = cleanDate - cleanStartDate;
            const dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
            
            // 偶数天（包括第0天）使用剂量1，奇数天使用剂量2
            return dayDiff % 2 === 0 ? settings.dose1 : settings.dose2;
        }
        
        // 更新今日状态
        function updateTodayStatus() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const todayDose = calculateDose(today);
            todayDoseEl.textContent = todayDose;
            
            // 更新按钮状态
            if (medicationRecords[todayStr]) {
                const status = medicationRecords[todayStr].status;
                if (status === 'taken') {
                    markTakenBtn.classList.add('bg-green-200', 'text-green-800');
                    markTakenBtn.classList.remove('bg-success', 'hover:bg-green-600', 'text-white');
                    markMissedBtn.classList.remove('bg-red-200', 'text-red-800');
                    markMissedBtn.classList.add('bg-danger', 'hover:bg-red-600', 'text-white');
                } else if (status === 'missed') {
                    markMissedBtn.classList.add('bg-red-200', 'text-red-800');
                    markMissedBtn.classList.remove('bg-danger', 'hover:bg-red-600', 'text-white');
                    markTakenBtn.classList.remove('bg-green-200', 'text-green-800');
                    markTakenBtn.classList.add('bg-success', 'hover:bg-green-600', 'text-white');
                }
            } else {
                // 重置按钮状态
                markTakenBtn.classList.remove('bg-green-200', 'text-green-800');
                markTakenBtn.classList.add('bg-success', 'hover:bg-green-600', 'text-white');
                markMissedBtn.classList.remove('bg-red-200', 'text-red-800');
                markMissedBtn.classList.add('bg-danger', 'hover:bg-red-600', 'text-white');
            }
        }
        
        // 更新统计信息
        function updateStatistics() {
            updateWeeklyChart();
            updateMonthlyChart();
            updateAdherence();
        }
        
        // 更新每周图表
        function updateWeeklyChart() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const weekData = [];
            const weekLabels = [];
            
            // 获取过去7天的数据
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][date.getDay()];
                
                weekLabels.push(dayName);
                
                const dose = calculateDose(date);
                const status = medicationRecords[dateStr] ? medicationRecords[dateStr].status : 'unknown';
                
                weekData.push({
                    date: dateStr,
                    dose: dose,
                    status: status
                });
            }
            
            // 销毁旧图表
            if (weeklyChart) {
                weeklyChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: '用药量（片）',
                        data: weekData.map(item => item.dose),
                        backgroundColor: weekData.map(item => {
                            if (item.status === 'taken') return 'rgba(16, 185, 129, 0.7)';
                            if (item.status === 'missed') return 'rgba(239, 68, 68, 0.7)';
                            return 'rgba(156, 163, 175, 0.7)';
                        }),
                        borderColor: weekData.map(item => {
                            if (item.status === 'taken') return 'rgb(5, 150, 105)';
                            if (item.status === 'missed') return 'rgb(220, 38, 38)';
                            return 'rgb(107, 114, 128)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '用药量（片）'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const status = weekData[index].status;
                                    if (status === 'taken') return '状态: 已服用';
                                    if (status === 'missed') return '状态: 未服用';
                                    return '状态: 未记录';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 更新每月图表
        function updateMonthlyChart() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // 获取当月天数
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const monthData = [];
            const weekLabels = [];
            
            let weekTotal = 0;
            let weekCount = 0;
            
            // 计算每周的用药总量
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayOfWeek = date.getDay();
                
                const dose = calculateDose(date);
                weekTotal += dose;
                
                // 周日或月末
                if (dayOfWeek === 0 || day === daysInMonth) {
                    weekCount++;
                    weekLabels.push(`第${weekCount}周`);
                    monthData.push(weekTotal);
                    weekTotal = 0;
                }
            }
            
            // 销毁旧图表
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: '每周用药总量（片）',
                        data: monthData,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '用药总量（片）'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新用药依从性
        function updateAdherence() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const cleanStartDate = new Date(settings.startDate);
            cleanStartDate.setHours(0, 0, 0, 0);
            
            // 计算总天数
            const timeDiff = today - cleanStartDate;
            const totalDays = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
            
            // 计算已服用天数
            let takenCount = 0;
            
            for (const dateStr in medicationRecords) {
                const date = new Date(dateStr);
                date.setHours(0, 0, 0, 0);
                
                if (date >= cleanStartDate && date <= today && medicationRecords[dateStr].status === 'taken') {
                    takenCount++;
                }
            }
            
            // 计算依从率
            const adherenceRate = totalDays > 0 ? Math.round((takenCount / totalDays) * 100) : 0;
            
            // 更新UI
            adherenceBar.style.width = `${adherenceRate}%`;
            takenCountEl.textContent = takenCount;
            totalDaysEl.textContent = totalDays;
            adherenceRateEl.textContent = adherenceRate;
            
            // 根据依从率设置颜色
            if (adherenceRate >= 90) {
                adherenceBar.classList.remove('bg-yellow-500', 'bg-red-500');
                adherenceBar.classList.add('bg-green-500');
            } else if (adherenceRate >= 70) {
                adherenceBar.classList.remove('bg-green-500', 'bg-red-500');
                adherenceBar.classList.add('bg-yellow-500');
            } else {
                adherenceBar.classList.remove('bg-green-500', 'bg-yellow-500');
                adherenceBar.classList.add('bg-red-500');
            }
        }
        
        // 显示状态对话框
        function showStatusDialog(date) {
            const dateStr = date.toISOString().split('T')[0];
            const dateObj = new Date(date);
            const formattedDate = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;
            
            const dose = calculateDose(date);
            
            // 检查是否已有记录
            const currentStatus = medicationRecords[dateStr] ? medicationRecords[dateStr].status : null;
            
            // 创建对话框
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">${formattedDate}</h3>
                        <p class="text-gray-600 mt-2">用药量: <span class="font-medium">${dose}</span> 片</p>
                    </div>
                    
                    <div class="flex space-x-4 mb-6">
                        <button class="status-btn flex-1 py-3 px-4 rounded-lg ${currentStatus === 'taken' ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'} transition-colors duration-300" data-status="taken">
                            <i class="fa fa-check-circle mr-2"></i>已服用
                        </button>
                        <button class="status-btn flex-1 py-3 px-4 rounded-lg ${currentStatus === 'missed' ? 'bg-red-100 text-red-800 border border-red-300' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'} transition-colors duration-300" data-status="missed">
                            <i class="fa fa-times-circle mr-2"></i>未服用
                        </button>
                    </div>
                    
                    <div class="text-center">
                        <button id="closeDialog" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors duration-300">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // 添加事件监听器
            dialog.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const status = btn.getAttribute('data-status');
                    updateMedicationStatus(dateStr, status);
                    document.body.removeChild(dialog);
                    renderCalendar(currentMonth, currentYear);
                    updateTodayStatus();
                    updateStatistics();
                    showToast(status === 'taken' ? '已标记为已服用' : '已标记为未服用');
                });
            });
            
            dialog.getElementById('closeDialog').addEventListener('click', () => {
                document.body.removeChild(dialog);
            });
        }
        
        // 更新用药状态
        function updateMedicationStatus(dateStr, status) {
            medicationRecords[dateStr] = {
                status: status,
                updatedAt: new Date().toISOString()
            };
            saveMedicationRecords();
        }
        
        // 显示提示框
        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 保存设置按钮
            saveSettingsBtn.addEventListener('click', () => {
                const dose1 = parseFloat(dose1Input.value);
                const dose2 = parseFloat(dose2Input.value);
                const startDate = new Date(startDateInput.value);
                
                if (isNaN(dose1) || isNaN(dose2) || dose1 <= 0 || dose2 <= 0) {
                    showToast('请输入有效的剂量');
                    return;
                }
                
                if (isNaN(startDate.getTime())) {
                    showToast('请选择有效的开始日期');
                    return;
                }
                
                settings.dose1 = dose1;
                settings.dose2 = dose2;
                settings.startDate = startDate;
                saveSettings();
                
                renderCalendar(currentMonth, currentYear);
                updateTodayStatus();
                updateStatistics();
                showToast('设置已保存');
            });
            
            // 上个月按钮
            prevMonthBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            // 下个月按钮
            nextMonthBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentMonth, currentYear);
            });
            
            // 标记已服用按钮
            markTakenBtn.addEventListener('click', () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];
                
                updateMedicationStatus(todayStr, 'taken');
                updateTodayStatus();
                renderCalendar(currentMonth, currentYear);
                updateStatistics();
                showToast('今日用药已标记为已服用');
            });
            
            // 标记未服用按钮
            markMissedBtn.addEventListener('click', () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];
                
                updateMedicationStatus(todayStr, 'missed');
                updateTodayStatus();
                renderCalendar(currentMonth, currentYear);
                updateStatistics();
                showToast('今日用药已标记为未服用');
            });
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
